<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gráfico de Tráfego</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f7f9fc;
        margin: 0;
        padding: 20px;
        color: #333;
    }
    .container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }
    .chart-container {
        flex: 1;
        min-width: 300px;
        max-width: 400px;
    }
    .info-box {
        flex: 1;
        min-width: 300px;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .info-box h3 {
        margin-top: 0;
        font-size: 1.3em;
        color: #444;
    }
    .info-box p {
        margin: 6px 0;
    }
    .info-ports {
        font-weight: bold;
        color: #555;
    }
    .info-examples {
        color: #666;
        font-size: 0.95em;
    }
    .records {
        margin-top: 10px;
        font-size: 0.9em;
        color: #555;
    }
</style>
</head>
<body>

<h2>Uso de Tráfego por Categoria</h2>

<div class="container">
    <div class="chart-container">
        <canvas id="trafficChart"></canvas>
    </div>
    <div class="info-box" id="infoBox">
        <h3>Selecione uma fatia</h3>
        <p>Porcentagem: -</p>
        <p class="info-ports">Portas: -</p>
        <p class="info-examples">Exemplos: -</p>
        <div class="records">Últimos registros: -</div>
    </div>
</div>

<script>
const portaExemplos = {
    443: "Acesso seguro a sites e apps: Google, YouTube, WhatsApp, Instagram, bancos online",
    80: "Acesso a sites não criptografados e alguns serviços antigos",
    53: "Resolução de nomes de sites (DNS)",
    25: "Envio de e-mails (SMTP)",
    465: "Envio seguro de e-mails (SMTP sobre SSL/TLS)",
    587: "Envio de e-mails autenticados (SMTP)",
    21: "Transferência de arquivos via FTP",
    outro: "Tráfego não identificado ou misto (pode incluir VPNs, jogos online, streaming, etc.)"
};

// Configuração Supabase
    const supabaseUrl = 'https://epruvcgigotpcptjaqyr.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwcnV2Y2dpZ290cGNwdGphcXlyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0Njk2MzcxMywiZXhwIjoyMDYyNTM5NzEzfQ.zIA2LO93He3kKRYhSv52w0GxoEFV9ILF7-uW196jb50';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function buscarDados() {
    // Exemplo: buscar tráfego agrupado
    const { data, error } = await supabaseClient
        .from("trafego")
        .select("*");

    if (error) {
        console.error("Erro ao buscar dados:", error);
        return [];
    }

    return data;
}

function agruparPorCategoria(dados) {
    const categorias = {};

    dados.forEach(item => {
        const porta = item.porta || "outro";
        if (!categorias[item.categoria]) {
            categorias[item.categoria] = { total: 0, portas: new Set(), registros: [] };
        }
        categorias[item.categoria].total += item.bytes;
        categorias[item.categoria].portas.add(porta);
        categorias[item.categoria].registros.push(item);
    });

    return categorias;
}

function criarGrafico(categorias) {
    const labels = Object.keys(categorias);
    const valores = labels.map(cat => categorias[cat].total);
    const cores = ["#a3d8f4", "#f9c0c0", "#fce2ae", "#b5ead7", "#c7ceea", "#ffd6a5"];

    const ctx = document.getElementById('trafficChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: cores
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let total = context.dataset.data.reduce((a,b) => a+b, 0);
                            let valor = context.parsed;
                            let porcentagem = ((valor / total) * 100).toFixed(1);
                            return `${context.label}: ${valor} bytes (${porcentagem}%)`;
                        }
                    }
                }
            },
            onClick: (evt, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    mostrarInfo(labels[index], categorias[labels[index]]);
                }
            }
        }
    });
}

function mostrarInfo(nome, dados) {
    const totalBytes = Object.values(dados.total).reduce ? dados.total : dados.total;
    const totalGeral = totalBytes; // Já é total
    const porcentagem = ((dados.total / calcularTotalGeral()) * 100).toFixed(1);

    const portas = Array.from(dados.portas).join(", ");
    const exemplos = Array.from(dados.portas).map(p => portaExemplos[p] || portaExemplos.outro).join(" | ");
    const ultimos = dados.registros.slice(-5).map(r => `Porta ${r.porta} - ${r.bytes} bytes`).join("<br>");

    document.getElementById("infoBox").innerHTML = `
        <h3>${nome}</h3>
        <p>Porcentagem: ${porcentagem}%</p>
        <p class="info-ports">Portas: ${portas}</p>
        <p class="info-examples">Exemplos: ${exemplos}</p>
        <div class="records">Últimos registros:<br>${ultimos}</div>
    `;
}

let totalGlobal = 0;
function calcularTotalGeral() {
    return totalGlobal;
}

(async () => {
    const dados = await buscarDados();
    const categorias = agruparPorCategoria(dados);
    totalGlobal = Object.values(categorias).reduce((soma, cat) => soma + cat.total, 0);
    criarGrafico(categorias);
})();
</script>
</body>
</html>
