<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Análise de Tráfego</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      gap: 20px;
      padding: 20px;
    }
    .grafico-pequeno {
      width: 50%;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .info-lateral {
      width: 50%;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .info-lateral h3 {
      margin-top: 0;
    }
    .legenda {
      margin-top: 15px;
      text-align: center;
    }
    .legenda span {
      display: inline-block;
      margin: 5px 10px;
    }
    .legenda span i {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="grafico-pequeno">
    <canvas id="graficoTrafego"></canvas>
    <div class="legenda" id="legendaCustom"></div>
  </div>
  <div class="info-lateral" id="infoTrafego">
    <h3>Selecione um tipo de tráfego</h3>
    <p>Clique em uma fatia do gráfico para ver detalhes e exemplos.</p>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://epruvcgigotpcptjaqyr.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwcnV2Y2dpZ290cGNwdGphcXlyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0Njk2MzcxMywiZXhwIjoyMDYyNTM5NzEzfQ.zIA2LO93He3kKRYhSv52w0GxoEFV9ILF7-uW196jb50';
  const supabase = createClient(supabaseUrl, supabaseKey);

  const portaParaTipo = {
    80: "HTTP",
    443: "HTTPS",
    21: "FTP",
    25: "SMTP",
    53: "DNS"
  };

  const descricoes = {
    "HTTP": "Tráfego web não criptografado, geralmente navegação em sites antigos ou servidores locais.",
    "HTTPS": "Tráfego web seguro, utilizado pela maioria dos sites modernos.",
    "FTP": "Transferência de arquivos entre servidores e clientes.",
    "SMTP": "Envio de e-mails.",
    "DNS": "Tradução de nomes de sites em endereços IP.",
    "Outros": "Tráfego que não se encaixa nas categorias principais."
  };

  function classificarTipo(porta) {
    return portaParaTipo[porta] || "Outros";
  }

  async function carregarDados() {
    const { data, error } = await supabase
      .from('trafego')
      .select('timestamp, porta');

    if (error) {
      console.error("Erro:", error);
      return;
    }

    const contagem = {};
    const registrosComTipo = data.map(reg => {
      const tipo = classificarTipo(reg.porta);
      contagem[tipo] = (contagem[tipo] || 0) + 1;
      return { ...reg, tipo };
    });

    desenharGrafico(contagem, data.length, registrosComTipo);
  }

  let chart;

  function desenharGrafico(contagem, total, todosDados) {
    const ctx = document.getElementById('graficoTrafego').getContext('2d');

    chart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(contagem),
        datasets: [{
          data: Object.values(contagem),
          backgroundColor: ['#4e9cff', '#f54291', '#33cc33', '#ffa500', '#cc33ff', '#ff3333', '#00cccc'],
          borderColor: 'white',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const label = ctx.label || '';
                const value = ctx.raw;
                const pct = ((value / total) * 100).toFixed(1);
                return `${label}: ${value} (${pct}%)`;
              }
            }
          },
          datalabels: { display: false }
        },
        onClick: async (event, elements) => {
          if (elements.length) {
            const label = chart.data.labels[elements[0].index];
            await mostrarInfoHibrido(label, todosDados, contagem, total);
          }
        }
      }
    });

    gerarLegendaPersonalizada(contagem, total);
  }

  function gerarLegendaPersonalizada(contagem, total) {
    const legendaContainer = document.getElementById('legendaCustom');
    legendaContainer.innerHTML = '';
    Object.entries(contagem).forEach(([tipo, valor], idx) => {
      const pct = ((valor / total) * 100).toFixed(1);
      const span = document.createElement('span');
      span.innerHTML = `<i style="background-color:${chart.data.datasets[0].backgroundColor[idx]}"></i>${tipo} (${pct}%)`;
      legendaContainer.appendChild(span);
    });
  }

  async function mostrarInfoHibrido(tipo, todosDados, contagem, total) {
    const registros = todosDados
      .filter(r => r.tipo === tipo)
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
      .slice(0, 5);

    const pct = ((contagem[tipo] / total) * 100).toFixed(1);
    let html = `<h3>${tipo}</h3>`;
    html += `<p>${descricoes[tipo] || "Tipo de tráfego não identificado."}</p>`;
    html += `<p><strong>Participação no total:</strong> ${pct}%</p>`;

    if (registros.length === 0) {
      html += `<p>Não há registros recentes deste tipo.</p>`;
    } else {
      html += `<p>Últimos registros:</p><ul>`;
      registros.forEach(reg => {
        const hora = new Date(reg.timestamp).toLocaleString();
        html += `<li>Porta: ${reg.porta} — ${hora}</li>`;
      });
      html += `</ul>`;
    }
    document.getElementById('infoTrafego').innerHTML = html;
  }

  carregarDados();
</script>

</body>
</html>
