<script>
  const { createClient } = window.supabase;
  const supabaseUrl = 'https://epruvcgigotpcptjaqyr.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
  const supabase = createClient(supabaseUrl, supabaseKey);

  // Configuração das categorias fixas
  const categoriasConfig = {
    OUTRO: {
      cor: "#4e9cff",
      portas: [],
      exemplos: "Tráfego genérico ou não identificado"
    },
    HTTP: {
      cor: "#ff3333",
      portas: [80, 8080],
      exemplos: "Sites comuns sem criptografia, APIs HTTP"
    },
    VPN: {
      cor: "#f54291",
      portas: [1194, 1701, 500, 4500],
      exemplos: "Serviços de VPN como OpenVPN, L2TP, IPSec"
    },
    DNS: {
      cor: "#33cc33",
      portas: [53],
      exemplos: "Tráfego usado para traduzir nomes de sites em endereços IP"
    },
    "HTTP WEB": {
      cor: "#ffa500",
      portas: [8080],
      exemplos: "Acesso web em servidores alternativos"
    },
    HTTPS: {
      cor: "#cc33ff",
      portas: [443],
      exemplos: "Sites seguros como Google, WhatsApp, Netflix, apps e streaming"
    }
  };

  let dadosAtuais = [];

  async function carregarDados() {
    const { data, error } = await supabase
      .from('trafego')
      .select('timestamp, tipo, porta')
      .order('timestamp', { ascending: false });

    if (error) {
      console.error("Erro ao buscar dados:", error);
      return;
    }
    dadosAtuais = data;
    desenharGrafico(data);
  }

  function desenharGrafico(data) {
    const contagem = {};
    data.forEach(registro => {
      const tipo = registro.tipo || 'OUTRO';
      contagem[tipo] = (contagem[tipo] || 0) + 1;
    });

    const total = data.length;
    const ctx = document.getElementById('graficoTrafego').getContext('2d');

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(contagem),
        datasets: [{
          data: Object.values(contagem),
          backgroundColor: Object.keys(contagem).map(c => categoriasConfig[c]?.cor || "#999999"),
          borderColor: 'white',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              generateLabels: (chart) => {
                const labels = chart.data.labels;
                return labels.map((label, i) => ({
                  text: label,
                  fillStyle: categoriasConfig[label]?.cor || "#999999",
                  strokeStyle: '#fff',
                  lineWidth: 2,
                  hidden: false,
                  index: i
                }));
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const categoria = context.label;
                const qtd = context.parsed;
                const porcent = ((qtd / total) * 100).toFixed(1) + "%";
                const desc = categoriasConfig[categoria]?.exemplos || "Sem descrição";
                return `${categoria}: ${qtd} (${porcent}) - ${desc}`;
              }
            }
          }
        },
        onClick: (evt, elements, chart) => {
          if (elements.length > 0) {
            const index = elements[0].index;
            const categoria = chart.data.labels[index];
            const qtd = chart.data.datasets[0].data[index];
            const porcentagem = ((qtd / total) * 100).toFixed(2) + '%';
            mostrarInfo(categoria, porcentagem);
          }
        }
      }
    });
  }

  function mostrarInfo(categoria, porcentagem) {
    const infoCaixa = document.getElementById("infoCaixa");
    const registrosCategoria = dadosAtuais.filter(d => d.tipo === categoria);
    const portasDetectadas = [...new Set(registrosCategoria.map(r => r.porta).filter(Boolean))];

    const config = categoriasConfig[categoria] || categoriasConfig.OUTRO;

    document.getElementById("infoCategoria").innerText = categoria;
    document.getElementById("infoCategoria").style.color = config.cor; // cor igual da legenda
    document.getElementById("infoPorcentagem").innerText = `Porcentagem: ${porcentagem}`;
    document.getElementById("infoPortas").innerText = portasDetectadas.length ? portasDetectadas.join(', ') : "N/A";
    document.getElementById("infoExemplos").innerText = config.exemplos;

    const lista = document.getElementById("infoRegistros");
    lista.innerHTML = "";
    registrosCategoria.slice(0, 5).forEach(r => {
      const li = document.createElement("li");
      li.innerText = `${r.timestamp} - Porta ${r.porta || "N/A"}`;
      lista.appendChild(li);
    });

    infoCaixa.style.display = "block";
  }

  function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); }
  function goToHome() { window.location.href = 'base.html'; }
  function verLogs() { window.location.href = 'logs.html'; }
  function verClassificacao() { window.location.href = 'classificação.html'; }
  function verPerfil() { window.location.href = 'perfil.html'; }
  function confirmLogout() { document.getElementById("logoutModal").style.display = "flex"; }
  function fecharModal() { document.getElementById("logoutModal").style.display = "none"; }
  function logout() { supabase.auth.signOut().then(() => window.location.href = 'index.html'); }

  window.onload = () => {
    carregarDados();
    lucide.createIcons();
  };
</script>
