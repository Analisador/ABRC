<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classificação de Tráfego</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            height: 100vh;
            display: flex;
            color: white;
            animation: gradientAnimation 12s ease infinite;
            background-size: 300% 300%;
            background-image: linear-gradient(-45deg, #c2142b, #2165ac, #f2c546, #c2142b);
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        nav.sidebar {
            background: rgba(0, 0, 0, 0.8);
            width: 220px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            gap: 25px;
            transition: transform 0.3s ease;
        }
        nav.sidebar h2 {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin: 0 0 25px 0;
        }
        nav.sidebar button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            user-select: none;
        }
        nav.sidebar button:hover { background-color: rgba(255, 255, 255, 0.1); }
        nav.sidebar button svg { stroke: white; width: 20px; height: 20px; }
        .sidebar-logo {
            width: 150px;
            margin: 20px auto 0 auto;
            display: block;
        }
        main.container {
            flex-grow: 1;
            background-color: rgba(0, 0, 0, 0.75);
            margin: 40px;
            padding: 40px;
            border-radius: 20px;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        h1 { text-align: center; margin-bottom: 30px; width: 100%; }
        .grafico-pequeno { width: 350px; height: 350px; margin: 0 auto; }
        .info-caixa {
            flex: 1;
            min-width: 250px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            display: none; /* Mantido como none, será exibido pelo JS */
        }
        .info-caixa h2 { margin-bottom: 10px; }
        .info-caixa p { margin-bottom: 6px; }
        .menu-toggle {
            display: none;
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1000;
        }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            nav.sidebar {
                position: fixed;
                top: 0; left: 0;
                height: 100%;
                transform: translateX(-100%);
                z-index: 999;
            }
            nav.sidebar.active { transform: translateX(0); }
            .menu-toggle { display: block; }
            main.container { margin: 20px; padding: 20px; }
            .grafico-pequeno { width: 250px; height: 250px; }
        }
        /* Modal logout */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            color: black;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            max-width: 320px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .btn-sim {
            background: #c2142b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-nao {
            background: #ccc;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <button class="menu-toggle" onclick="toggleMenu()"><i data-lucide="menu"></i></button>

    <nav class="sidebar" id="sidebar">
        <div>
            <h2>A.B.R.C</h2>
            <button onclick="goToHome()"><i data-lucide="gauge"></i> Speed Test</button>
            <button onclick="verLogs()"><i data-lucide="file-text"></i> Logs</button>
            <button onclick="verClassificacao()"><i data-lucide="bar-chart-2"></i> Tráfego</button>
            <button onclick="verPerfil()"><i data-lucide="user"></i> Perfil</button>
            <button onclick="confirmLogout()"><i data-lucide="log-out"></i> Logout</button>
        </div>
        <img src="images/logo-abrc.png" alt="Logo" class="sidebar-logo">
    </nav>

    <main class="container">
        <h1>Classificação de Tráfego</h1>
        <canvas id="graficoTrafego" class="grafico-pequeno"></canvas>

        <div class="info-caixa" id="infoCaixa">
            <h2 id="infoCategoria"></h2>
            <p id="infoDescricao"></p>
            <p id="infoPorcentagem"></p>
            <p><strong>Portas (Registradas):</strong> <span id="infoPortas"></span></p>
            <p><strong>Exemplos:</strong> <span id="infoExemplos"></span></p>
            <div>
                <strong>Últimos Registros:</strong>
                <ul id="infoRegistros"></ul>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="logoutModal">
        <div class="modal-content">
            <h3>Deseja realmente sair?</h3>
            <div class="modal-buttons">
                <button class="btn-sim" onclick="logout()">Sim</button>
                <button class="btn-nao" onclick="fecharModal()">Não</button>
            </div>
        </div>
    </div>

    <script>
        const { createClient } = window.supabase;
        const supabaseUrl = 'https://epruvcgigotpcptjaqyr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwcnV2Y2dpZ290cGNwdGphcXlyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0Njk2MzcxMywiZXhwIjoyMDYyNTM5NzEzfQ.zIA2LO93He3kKRYhSv52w0GxoEFV9ILF7-uW196jb50';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // O NOVO MAPEMANTO DE DADOS PARA DESCRIÇÃO AMIGÁVEL
        const mapeamentoDados = {
            "DNS": {
                descricao: "Sistema de Nomes de Domínio, a 'agenda telefônica' da internet. Traduz o nome do site (ex: google.com) para o endereço IP.",
                exemplos: ["Resolução de endereços web"],
            },
            "HTTP": {
                descricao: "Protocolo de navegação **não segura**. Os dados trafegam abertos na rede, evite em sites com dados sensíveis.",
                exemplos: ["Navegação web antiga ou de teste", "APIs HTTP"],
            },
            "HTTPS": {
                descricao: "Protocolo de navegação **segura**. Criptografa seus dados para proteger sua informação (o 'S' de Segurança).",
                exemplos: ["Sites de bancos", "Redes sociais", "APIs seguras"],
            },
            "VPNs": {
                descricao: "Redes Virtuais Privadas. Criam um 'túnel' seguro e criptografado para proteger sua privacidade e mascarar sua localização.",
                exemplos: ["Acesso remoto a redes empresariais"],
            },
            "OUTRO": {
                descricao: "Tráfego que não se encaixa nas categorias principais. Pode ser protocolos específicos, desconhecidos ou de uso misto.",
                exemplos: ["Protocolos menos comuns"],
            },
            // Se houver tipos de tráfego que não são os principais (ex: FTP, SMTP direto do BD), adicione aqui.
            "FTP": {
                descricao: "Protocolo de Transferência de Arquivos. Usado para enviar e receber arquivos grandes entre computadores.",
                exemplos: ["Upload de sites", "Transferência de logs"],
            },
            "SMTP": {
                descricao: "Protocolo Simples de Transferência de Correio. Usado principalmente por servidores para **enviar** e-mails.",
                exemplos: ["Envio de e-mails"],
            },
        };

        let dadosAtuais = [];

        async function carregarDados() {
            const { data, error } = await supabase
                .from('trafego')
                .select('timestamp, tipo, porta')
                .order('timestamp', { ascending: false });

            if (error) {
                console.error("Erro ao buscar dados:", error);
                return;
            }
            dadosAtuais = data;
            desenharGrafico(data);
        }

        function desenharGrafico(data) {
            const contagem = {};
            data.forEach(registro => {
                const tipo = registro.tipo || 'OUTRO'; // Fallback para 'OUTRO'
                contagem[tipo] = (contagem[tipo] || 0) + 1;
            });

            const total = data.length;
            const ctx = document.getElementById('graficoTrafego').getContext('2d');

            // Verifica se o gráfico já existe para evitar erro de re-inicialização
            if (window.trafegoChart) {
                window.trafegoChart.destroy();
            }

            window.trafegoChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(contagem),
                    datasets: [{
                        data: Object.values(contagem),
                        backgroundColor: ['#4e9cff', '#f54291', '#33cc33', '#ffa500', '#cc33ff', '#ff3333', '#00cccc'],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const categoria = window.trafegoChart.data.labels[index];
                            const qtd = window.trafegoChart.data.datasets[0].data[index];
                            const porcentagem = ((qtd / total) * 100).toFixed(2) + '%';
                            mostrarInfo(categoria, porcentagem);
                        }
                    }
                }
            });
        }

        // FUNÇÃO AJUSTADA PARA USAR O NOVO MAPEMANTO
        function mostrarInfo(categoria, porcentagem) {
            const infoCaixa = document.getElementById("infoCaixa");
            // Filtra os registros que pertencem a esta categoria
            const registrosCategoria = dadosAtuais.filter(d => d.tipo === categoria);

            // Busca a informação no mapeamento, com fallback para um objeto vazio
            const infoMapeada = mapeamentoDados[categoria] || {
                descricao: "Categoria sem descrição detalhada. Investigue os logs para mais informações.",
                exemplos: [],
            };

            // Coleta as portas únicas usadas nos registros reais
            const portasRegistradas = [...new Set(registrosCategoria.map(r => r.porta).filter(Boolean))];

            // Preenche os elementos
            document.getElementById("infoCategoria").innerText = categoria;
            document.getElementById("infoDescricao").innerText = infoMapeada.descricao;
            document.getElementById("infoPorcentagem").innerText = `Porcentagem do Total: ${porcentagem}`;
            document.getElementById("infoPortas").innerText = portasRegistradas.length ? portasRegistradas.join(', ') : "N/A";
            document.getElementById("infoExemplos").innerText = infoMapeada.exemplos.length ? infoMapeada.exemplos.join('; ') : "N/A";

            // Preenche a lista de últimos registros
            const lista = document.getElementById("infoRegistros");
            lista.innerHTML = "";
            registrosCategoria.slice(0, 5).forEach(r => {
                const dataFormatada = new Date(r.timestamp).toLocaleTimeString('pt-BR');
                const li = document.createElement("li");
                li.innerText = `${dataFormatada} - Porta ${r.porta || "N/A"}`;
                lista.appendChild(li);
            });

            infoCaixa.style.display = "block";
        }
        // FIM DA FUNÇÃO AJUSTADA

        function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); }
        function goToHome() { window.location.href = 'base.html'; }
        function verLogs() { window.location.href = 'logs.html'; }
        function verClassificacao() { window.location.href = 'classificação.html'; }
        function verPerfil() { window.location.href = 'perfil.html'; }
        function confirmLogout() { document.getElementById("logoutModal").style.display = "flex"; }
        function fecharModal() { document.getElementById("logoutModal").style.display = "none"; }
        function logout() { supabase.auth.signOut().then(() => window.location.href = 'index.html'); }

        window.onload = () => {
            carregarDados();
            lucide.createIcons();
        };
    </script>
</body>

</html>
