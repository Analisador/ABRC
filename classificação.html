<script>
  const { createClient } = window.supabase;
  const supabaseUrl = 'https://epruvcgigotpcptjaqyr.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwcnV2Y2dpZ290cGNwdGphcXlyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0Njk2MzcxMywiZXhwIjoyMDYyNTM5NzEzfQ.zIA2LO93He3kKRYhSv52w0GxoEFV9ILF7-uW196jb50';
  const supabase = createClient(supabaseUrl, supabaseKey);

  // Configuração das categorias fixas (agora com explicação leiga)
  const categoriasConfig = {
    OUTRO: {
      cor: "#4e9cff",
      portas: [],
      exemplos: "Tráfego genérico ou não identificado",
      definicao: "Dados que não se encaixam em nenhuma categoria específica."
    },
    HTTP: {
      cor: "#ff3333",
      portas: [80, 8080],
      exemplos: "Navegação não segura, APIs HTTP",
      definicao: "Sites comuns sem segurança (http://). Exemplo: páginas antigas ou não criptografadas."
    },
    VPN: {
      cor: "#f54291",
      portas: [1194, 1701, 500, 4500],
      exemplos: "OpenVPN, L2TP, IPSec",
      definicao: "Conexões privadas seguras usadas para esconder ou proteger navegação."
    },
    DNS: {
      cor: "#33cc33",
      portas: [53],
      exemplos: "Resolução de nomes de domínio",
      definicao: "Tráfego usado para transformar endereços como google.com em números IP."
    },
    "HTTP WEB": {
      cor: "#ffa500",
      portas: [8080],
      exemplos: "Navegação web padrão em servidores alternativos",
      definicao: "Tráfego de sites rodando em portas não padrão (ex: sistemas internos, APIs)."
    },
    HTTPS: {
      cor: "#cc33ff",
      portas: [443],
      exemplos: "Sites seguros, APIs, apps como WhatsApp e streaming",
      definicao: "Sites com segurança (https://). Exemplo: Google, YouTube, Netflix, WhatsApp Web."
    }
  };

  let dadosAtuais = [];
  let chart = null;

  async function carregarDados() {
    const { data, error } = await supabase
      .from('trafego')
      .select('timestamp, tipo, porta')
      .order('timestamp', { ascending: false });

    if (error) {
      console.error("Erro ao buscar dados:", error);
      return;
    }
    dadosAtuais = data;
    desenharGrafico(data);
  }

  function desenharGrafico(data) {
    const contagem = {};
    data.forEach(registro => {
      const tipo = registro.tipo || 'OUTRO';
      contagem[tipo] = (contagem[tipo] || 0) + 1;
    });

    const total = data.length;
    const ctx = document.getElementById('graficoTrafego').getContext('2d');

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(contagem),
        datasets: [{
          data: Object.values(contagem),
          backgroundColor: Object.keys(contagem).map(c => categoriasConfig[c]?.cor || "#999999"),
          borderColor: 'white',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        onClick: (evt, elements) => {
          if (elements.length > 0) {
            const index = elements[0].index;
            const categoria = chart.data.labels[index];
            const qtd = chart.data.datasets[0].data[index];
            const porcentagem = ((qtd / total) * 100).toFixed(2) + '%';
            mostrarInfo(categoria, porcentagem);
          }
        }
      }
    });

    gerarLegenda(Object.keys(contagem));
  }

  function gerarLegenda(categorias) {
    const legendaDiv = document.getElementById("graficoLegenda");
    if (!legendaDiv) return;
    legendaDiv.innerHTML = "";
    categorias.forEach(c => {
      const item = document.createElement("div");
      item.className = "legenda-item";
      item.innerHTML = `<span class="legenda-cor" style="background:${categoriasConfig[c]?.cor || "#999"}"></span>${c}`;
      legendaDiv.appendChild(item);
    });
  }

  function mostrarInfo(categoria, porcentagem) {
    const infoCaixa = document.getElementById("infoCaixa");
    const registrosCategoria = dadosAtuais.filter(d => d.tipo === categoria);
    const portasDetectadas = [...new Set(registrosCategoria.map(r => r.porta).filter(Boolean))];

    const config = categoriasConfig[categoria] || categoriasConfig.OUTRO;

    document.getElementById("infoCategoria").innerText = categoria;
    document.getElementById("infoPorcentagem").innerText = `Porcentagem: ${porcentagem}`;
    document.getElementById("infoPortas").innerText = portasDetectadas.length ? portasDetectadas.join(', ') : "N/A";
    document.getElementById("infoExemplos").innerText = config.exemplos;
    document.getElementById("infoDefinicao").innerText = config.definicao || "Sem definição disponível";

    const lista = document.getElementById("infoRegistros");
    lista.innerHTML = "";
    registrosCategoria.slice(0, 5).forEach(r => {
      const li = document.createElement("li");
      li.innerText = `${r.timestamp} - Porta ${r.porta || "N/A"}`;
      lista.appendChild(li);
    });

    infoCaixa.style.display = "block";
  }

  function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); }
  function goToHome() { window.location.href = 'base.html'; }
  function verLogs() { window.location.href = 'logs.html'; }
  function verClassificacao() { window.location.href = 'classificação.html'; }
  function verPerfil() { window.location.href = 'perfil.html'; }
  function confirmLogout() { document.getElementById("logoutModal").style.display = "flex"; }
  function fecharModal() { document.getElementById("logoutModal").style.display = "none"; }
  function logout() { supabase.auth.signOut().then(() => window.location.href = 'index.html'); }

  window.onload = () => {
    carregarDados();
    lucide.createIcons();
  };
</script>
