<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classificação de Tráfego</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            height: 100vh;
            display: flex;
            color: white;
            animation: gradientAnimation 12s ease infinite;
            background-size: 300% 300%;
            background-image: linear-gradient(-45deg, #c2142b, #2165ac, #f2c546, #c2142b);
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        nav.sidebar {
            background: rgba(0, 0, 0, 0.8);
            width: 220px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            gap: 25px;
            transition: transform 0.3s ease;
        }
        nav.sidebar h2 {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin: 0 0 25px 0;
        }
        nav.sidebar button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            user-select: none;
        }
        nav.sidebar button:hover { background-color: rgba(255, 255, 255, 0.1); }
        nav.sidebar button svg { stroke: white; width: 20px; height: 20px; }
        .sidebar-logo {
            width: 150px;
            margin: 20px auto 0 auto;
            display: block;
        }
        main.container {
            flex-grow: 1;
            background-color: rgba(0, 0, 0, 0.75);
            margin: 40px;
            padding: 40px;
            border-radius: 20px;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        h1 { text-align: center; margin-bottom: 30px; width: 100%; }
        .grafico-pequeno { width: 350px; height: 350px; margin: 0 auto; }
        .info-caixa {
            flex: 1;
            min-width: 250px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            display: none;
        }
        .info-caixa h2 { margin-bottom: 10px; }
        .info-caixa p { margin-bottom: 6px; }
        .menu-toggle {
            display: none;
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1000;
        }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            nav.sidebar {
                position: fixed;
                top: 0; left: 0;
                height: 100%;
                transform: translateX(-100%);
                z-index: 999;
            }
            nav.sidebar.active { transform: translateX(0); }
            .menu-toggle { display: block; }
            main.container { margin: 20px; padding: 20px; }
            .grafico-pequeno { width: 250px; height: 250px; }
        }
        /* Modal logout */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            color: black;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            max-width: 320px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .btn-sim {
            background: #c2142b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-nao {
            background: #ccc;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <button class="menu-toggle" onclick="toggleMenu()"><i data-lucide="menu"></i></button>

    <nav class="sidebar" id="sidebar">
        <div>
            <h2>A.B.R.C</h2>
            <button onclick="goToHome()"><i data-lucide="gauge"></i> Speed Test</button>
            <button onclick="verLogs()"><i data-lucide="file-text"></i> Logs</button>
            <button onclick="verClassificacao()"><i data-lucide="bar-chart-2"></i> Tráfego</button>
            <button onclick="verPerfil()"><i data-lucide="user"></i> Perfil</button>
            <button onclick="confirmLogout()"><i data-lucide="log-out"></i> Logout</button>
        </div>
        <img src="images/logo-abrc.png" alt="Logo" class="sidebar-logo">
    </nav>

    <main class="container">
        <h1>Classificação de Tráfego</h1>
        <canvas id="graficoTrafego" class="grafico-pequeno"></canvas>

        <div class="info-caixa" id="infoCaixa">
            <h2 id="infoCategoria"></h2>
            <p id="infoDescricao"></p>
            <p id="infoPorcentagem"></p>
            <p><strong>Portas (Registradas):</strong> <span id="infoPortas"></span></p>
            <p><strong>Exemplos:</strong> <span id="infoExemplos"></span></p>
            <div>
                <strong>Últimos Registros:</strong>
                <ul id="infoRegistros"></ul>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="logoutModal">
        <div class="modal-content">
            <h3>Deseja realmente sair?</h3>
            <div class="modal-buttons">
                <button class="btn-sim" onclick="logout()">Sim</button>
                <button class="btn-nao" onclick="fecharModal()">Não</button>
            </div>
        </div>
    </div>

    <script>
        const { createClient } = window.supabase;
    const supabaseUrl = 'https://epruvcgigotpcptjaqyr.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwcnV2Y2dpZ290cGNwdGphcXlyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0Njk2MzcxMywiZXhwIjoyMDYyNTM5NzEzfQ.zIA2LO93He3kKRYhSv52w0GxoEFV9ILF7-uW196jb50';
    const supabase = createClient(supabaseUrl, supabaseKey);

        // MAPA DE DESCRIÇÕES COMPLETO
        const mapeamentoDados = {
            "FTP - Dados": {
                descricao: "Transferência de arquivos via FTP.",
                exemplos: ["Upload de sites", "Transferência de logs"],
            },
            "DHCPv6 Server": {
                descricao: "Distribuição de endereços IPv6 em redes.",
                exemplos: ["Configuração automática de IPs IPv6"],
            },
            "Outro": {
                descricao: "Tráfego que não se encaixa nas categorias conhecidas.",
                exemplos: ["Protocolos incomuns"],
            },
            "TCMUX – TCP Port Service Multiplexer": {
                descricao: "Multiplexador de serviços TCP (antigo).",
                exemplos: ["Compatibilidade de sistemas legados"],
            },
            "VPNs stealth via TLS (OpenVPN, etc.)": {
                descricao: "VPNs que usam TLS/HTTPS para mascarar tráfego.",
                exemplos: ["OpenVPN disfarçado como HTTPS"],
            },
            "Porta inválida ou desconhecida": {
                descricao: "Tentativas em portas não registradas.",
                exemplos: ["Tráfego suspeito ou malformado"],
            },
            "NETBIOS-NS – NetBIOS Name Service": {
                descricao: "Serviço de resolução de nomes em redes Windows antigas.",
                exemplos: ["Descoberta de computadores em LAN"],
            },
            "DNS - Resolução de nomes": {
                descricao: "Sistema de tradução de nomes de domínio para IP.",
                exemplos: ["Resolução de sites como google.com"],
            },
            "DHCP BOOTP Server – DHCP servidor": {
                descricao: "Servidor que distribui IPs automaticamente.",
                exemplos: ["Rede corporativa"],
            },
            "HTTP - Navegação web padrão (insegura)": {
                descricao: "Protocolo de navegação sem criptografia.",
                exemplos: ["Sites antigos", "APIs sem HTTPS"],
            },
            "POP3 – Recebimento de e-mails POP3": {
                descricao: "Protocolo para baixar emails do servidor.",
                exemplos: ["Clientes de e-mail POP3"],
            },
            "mDNS - Multicast DNS": {
                descricao: "Resolução de nomes em redes locais via multicast.",
                exemplos: ["Apple Bonjour", "Impressoras locais"],
            },
            "GOPHER – Protocolo Gopher (antigo)": {
                descricao: "Protocolo antigo de navegação pré-web.",
                exemplos: ["Sistemas legados educacionais"],
            },
            "DHCP BOOTP Client – DHCP cliente": {
                descricao: "Cliente que solicita IP automaticamente.",
                exemplos: ["Computador recebendo IP da rede"],
            },
            "ECHO – Teste de conectividade (echo)": {
                descricao: "Resposta de eco para testes.",
                exemplos: ["Teste de conectividade de rede"],
            },
            "DCE/RPC – Microsoft endpoint mapper": {
                descricao: "Comunicação entre aplicativos distribuídos Microsoft.",
                exemplos: ["Serviços do Windows"],
            },
            "LLMNR - Link-Local Multicast Name Resolution": {
                descricao: "Resolução de nomes em redes locais sem DNS.",
                exemplos: ["Windows discovery em LAN"],
            },
            "SSH/SFTP - Acesso remoto seguro": {
                descricao: "Acesso remoto seguro com criptografia.",
                exemplos: ["Administração de servidores via SSH"],
            },
            "HOSTNAME – Resolução de nome de host (legacy)": {
                descricao: "Protocolo antigo de resolução de nomes.",
                exemplos: ["Compatibilidade com sistemas antigos"],
            },
            "DAYTIME – Data e hora do servidor": {
                descricao: "Serviço que retorna data e hora.",
                exemplos: ["Servidores de hora antigos"],
            },
            "SFTP – Secure File Transfer Protocol (legacy)": {
                descricao: "Transferência de arquivos segura.",
                exemplos: ["Envio seguro de arquivos"],
            },
            "RTELNET – Telnet remoto alternativo": {
                descricao: "Variante do protocolo Telnet.",
                exemplos: ["Administração de sistemas legados"],
            },
            "UPnP (SSDP) – Descoberta de dispositivos na rede (UDP)": {
                descricao: "Protocolo de descoberta de dispositivos em redes locais.",
                exemplos: ["Smart TVs", "Impressoras", "Câmeras de rede"],
            }
        };

        function normalizarCategoria(tipo) {
            if (!tipo) return "Outro";
            return tipo;
        }

        let dadosAtuais = [];

        async function carregarDados() {
            const { data, error } = await supabase
                .from('trafego')
                .select('timestamp, tipo, porta')
                .order('timestamp', { ascending: false });

            if (error) {
                console.error("Erro ao buscar dados:", error);
                return;
            }
            dadosAtuais = data;
            desenharGrafico(data);
        }

        function desenharGrafico(data) {
            const contagem = {};
            data.forEach(registro => {
                const tipo = normalizarCategoria(registro.tipo);
                contagem[tipo] = (contagem[tipo] || 0) + 1;
            });

            const total = data.length;
            const ctx = document.getElementById('graficoTrafego').getContext('2d');

            if (window.trafegoChart) {
                window.trafegoChart.destroy();
            }

            window.trafegoChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(contagem),
                    datasets: [{
                        data: Object.values(contagem),
                        backgroundColor: [
                            '#4e9cff', '#f54291', '#33cc33', '#ffa500', '#cc33ff',
                            '#ff3333', '#00cccc', '#9966ff', '#ffcc00', '#ff6600',
                            '#3399ff', '#66cc66', '#cc0066', '#990000', '#003366',
                            '#6600cc', '#009999', '#999900', '#cc3300', '#006600',
                            '#663300', '#009933', '#3333cc'
                        ],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const categoria = window.trafegoChart.data.labels[index];
                            const qtd = window.trafegoChart.data.datasets[0].data[index];
                            const porcentagem = ((qtd / total) * 100).toFixed(2) + '%';
                            mostrarInfo(categoria, porcentagem);
                        }
                    }
                }
            });
        }

        function mostrarInfo(categoria, porcentagem) {
            const infoCaixa = document.getElementById("infoCaixa");
            const registrosCategoria = dadosAtuais.filter(d => normalizarCategoria(d.tipo) === categoria);

            const infoMapeada = mapeamentoDados[categoria] || {
                descricao: "Categoria sem descrição detalhada.",
                exemplos: [],
            };

            const portasRegistradas = [...new Set(registrosCategoria.map(r => r.porta).filter(Boolean))];

            document.getElementById("infoCategoria").innerText = categoria;
            document.getElementById("infoDescricao").innerText = infoMapeada.descricao;
            document.getElementById("infoPorcentagem").innerText = `Porcentagem do Total: ${porcentagem}`;
            document.getElementById("infoPortas").innerText = portasRegistradas.length ? portasRegistradas.join(', ') : "N/A";
            document.getElementById("infoExemplos").innerText = infoMapeada.exemplos.length ? infoMapeada.exemplos.join('; ') : "N/A";

            const lista = document.getElementById("infoRegistros");
            lista.innerHTML = "";
            registrosCategoria.slice(0, 5).forEach(r => {
                const dataFormatada = new Date(r.timestamp).toLocaleTimeString('pt-BR');
                const li = document.createElement("li");
                li.innerText = `${dataFormatada} - Porta ${r.porta || "N/A"}`;
                lista.appendChild(li);
            });

            infoCaixa.style.display = "block";
        }

        function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); }
        function goToHome() { window.location.href = 'base.html'; }
        function verLogs() { window.location.href = 'logs.html'; }
        function verClassificacao() { window.location.href = 'classificação.html'; }
        function verPerfil() { window.location.href = 'perfil.html'; }
        function confirmLogout() { document.getElementById("logoutModal").style.display = "flex"; }
        function fecharModal() { document.getElementById("logoutModal").style.display = "none"; }
        function logout() { supabase.auth.signOut().then(() => window.location.href = 'index.html'); }

        window.onload = () => {
            carregarDados();
            lucide.createIcons();
        };
    </script>
</body>
</html>
