<script>
  const { createClient } = supabase;
  const supabaseUrl = 'https://epruvcgigotpcptjaqyr.supabase.co';
  const supabaseKey = 'SEU-ANON-KEY-AQUI'; // ⚠️ nunca use service_key no front!
  const supabaseClient = createClient(supabaseUrl, supabaseKey);

  let userEmail = null;
  let linhaId = null;

  async function carregarUsuario() {
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
    if (userError || !user) {
      alert("Usuário não autenticado");
      window.location.href = "LoginProjet.html";
      return;
    }
    userEmail = user.email;

    const { data: rows } = await supabaseClient
      .from('cadastro')
      .select('id, primeiro, segundo, terceiro, foto_url')
      .eq('email', userEmail)
      .order('id', { ascending: false })
      .limit(1);

    if (rows && rows.length > 0) {
      const row = rows[0];
      linhaId = row.id;
      document.getElementById('primeiro').value = toHHMM(row.primeiro);
      document.getElementById('segundo').value = toHHMM(row.segundo);
      document.getElementById('terceiro').value = toHHMM(row.terceiro);

      if (row.foto_url) {
        document.getElementById('preview').src = row.foto_url;
      }
    }
  }

  async function salvarHorarios() {
    const primeiro = padHHMMSS(document.getElementById('primeiro').value || null);
    const segundo = padHHMMSS(document.getElementById('segundo').value || null);
    const terceiro = padHHMMSS(document.getElementById('terceiro').value || null);

    if (linhaId) {
      await supabaseClient.from('cadastro').update({ primeiro, segundo, terceiro }).eq('id', linhaId);
      alert('Horários salvos com sucesso!');
      return;
    }
    if (!userEmail) { alert('Usuário não autenticado.'); return; }
    const { data } = await supabaseClient.from('cadastro').update({ primeiro, segundo, terceiro }).eq('email', userEmail).select('id');
    if (!data || data.length === 0) { alert('Seu cadastro ainda não existe. Conclua o cadastro primeiro.'); return; }
    alert('Horários salvos com sucesso!');
  }

  function mostrarPreview(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Mostra preview
    document.getElementById('preview').src = URL.createObjectURL(file);

    // Faz upload
    uploadFoto(file);
  }

  async function uploadFoto(file) {
    if (!userEmail) {
      alert("Usuário não autenticado");
      return;
    }

    const fileExt = file.name.split('.').pop();
    const fileName = `${userEmail.replace(/[@.]/g, "_")}_${Date.now()}.${fileExt}`;
    const filePath = `avatars/${fileName}`;

    let { error: uploadError } = await supabaseClient.storage
      .from('avatars') // bucket precisa existir
      .upload(filePath, file, {
        upsert: true,
      });

    if (uploadError) {
      alert("Erro ao enviar foto: " + uploadError.message);
      return;
    }

    // Gera URL pública
    const { data } = supabaseClient.storage.from('avatars').getPublicUrl(filePath);
    const publicUrl = data.publicUrl;

    // Salva URL no banco
    if (linhaId) {
      await supabaseClient.from('cadastro').update({ foto_url: publicUrl }).eq('id', linhaId);
    } else {
      await supabaseClient.from('cadastro').update({ foto_url: publicUrl }).eq('email', userEmail);
    }

    alert("Foto atualizada com sucesso!");
  }

  // Utils
  function padHHMMSS(v) { if (!v) return null; return /^\d{2}:\d{2}$/.test(v) ? v + ':00' : v; }
  function toHHMM(v) { return (typeof v === 'string' && /^\d{2}:\d{2}:\d{2}$/.test(v)) ? v.slice(0,5) : (v || ''); }

  // Navegação
  function goToHome() { window.location.href = 'base.html'; }
  function verLogs() { window.location.href = 'logs.html'; }
  function verClassificacao() { window.location.href = 'classificação.html'; }
  function verPerfil() { window.location.href = 'perfil.html'; }

  // Logout popup
  function showLogoutPopup() { document.getElementById("logoutPopup").style.display = "flex"; }
  function closeLogoutPopup() { document.getElementById("logoutPopup").style.display = "none"; }
  function confirmLogout() {
    supabaseClient.auth.signOut().then(() => {
      window.location.href = 'index.html';
    });
  }

  window.onload = () => { carregarUsuario(); lucide.createIcons(); };
  function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); }
</script>
